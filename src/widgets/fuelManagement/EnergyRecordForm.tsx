import { Box } from '@shared/components/ui/box';
import { FormControl } from '@shared/components/ui/form-control';
import { Button, ButtonText } from '@shared/components/ui/button';
import { useMemo, useReducer, useEffect } from 'react';

import { format, formatDate } from 'date-fns';
import { ko } from 'date-fns/locale';
import { useStations } from '@features/station';

import { formatDateForDisplay } from '@/shared/utils/format';
import { FormCard } from '@/shared/components/form/FormCard';
import { FormLabel } from '@/shared/components/form/FormLabel';
import { FormField } from '@/shared/components/form/FormField';
import { PaymentMethodModal } from '../../features/paymentMethods/ui/PaymentMethodModal';
import { StationPickerModal } from '../../features/station/ui/StationPickerModal';
import { FloatingSubmitButton } from '@/shared/components/FloatingSubmitButton';
import { ScrollView } from 'react-native';
import { useModal } from '@/shared/hooks/useModal';
import { DateSelectModal } from './ui/DateSelectModal';
import { CreateFuelRecordData } from '@/shared/models/FuelRecord';
import { MarkedDates } from 'react-native-calendars/src/types';

import { calendarTheme } from '@/shared/constants/calendar';

type EnergyRecordFormData = Omit<CreateFuelRecordData, 'id' | 'vehicleId'>;

interface EnergyRecordFormProps {
  vehicleType: 'ICE' | 'EV';
  initialFormData?: EnergyRecordFormData;
  onSubmit: (energyRecord: EnergyRecordFormData) => void;
}

export function EnergyRecordForm({
  vehicleType,
  initialFormData,
  onSubmit,
}: EnergyRecordFormProps) {
  // Î¶¨ÎìÄÏÑú Ïï°ÏÖò ÌÉÄÏûÖ Ï†ïÏùò
  type Action =
    | {
        type: 'SET_FIELD';
        field: keyof EnergyRecordFormData;
        value: EnergyRecordFormData[keyof EnergyRecordFormData];
      }
    | { type: 'BULK_UPDATE'; payload: Partial<EnergyRecordFormData> }
    | { type: 'RESET'; payload?: EnergyRecordFormData };

  // Î¶¨ÎìÄÏÑú Ìï®Ïàò
  function energyRecordReducer(
    state: EnergyRecordFormData,
    action: Action,
  ): EnergyRecordFormData {
    switch (action.type) {
      case 'SET_FIELD':
        return { ...state, [action.field]: action.value };
      case 'BULK_UPDATE':
        return { ...state, ...action.payload };
      case 'RESET':
        return action.payload ?? initialState;
      default:
        return state;
    }
  }

  // Ï¥àÍ∏∞Í∞í
  const initialState: EnergyRecordFormData = {
    date: new Date().getTime(),
    odometer: 0,
    totalCost: 0,
    unitPrice: 0,
    amount: 0,
    paymentMethodId: '',
    paymentName: '',
    paymentType: 'credit',
    stationId: '',
    stationName: '',
    memo: '',
    ...initialFormData,
  };

  // useReducerÎ°ú ÏÉÅÌÉú Í¥ÄÎ¶¨
  const [energyRecord, dispatch] = useReducer(
    energyRecordReducer,
    initialState,
  );

  // initialFormDataÍ∞Ä Î∞îÎÄî Îïå RESET
  useEffect(() => {
    dispatch({
      type: 'RESET',
      payload: { ...initialState, ...initialFormData },
    });
  }, [initialFormData]);

  // ÎÇ†Ïßú ÏÑ†ÌÉùÍ∏∞ ÏÉÅÌÉú
  const dateModal = useModal();
  const stationModal = useModal();
  const paymentModal = useModal();

  // ÏÉàÎ°úÏö¥ TanStack Query Î∞©Ïãù ÏÇ¨Ïö©
  const { data: stations = [] } = useStations();

  const selectedStation = useMemo(
    () => stations.find((s) => s.id === energyRecord.stationId),
    [stations, energyRecord.stationId],
  );

  // Ï∞®Îüâ ÌÉÄÏûÖÎ≥Ñ ÏÑ§Ï†ï
  const isEV = vehicleType === 'EV';
  const config = useMemo(
    () => ({
      energyType: isEV ? 'Ï∂©Ï†Ñ' : 'Ï£ºÏú†',
      icon: isEV ? 'üîã' : '‚õΩ',
      unit: isEV ? 'kWh' : 'L',
      unitPrice: isEV ? 'Ïõê/kWh' : 'Ïõê/L',
      station: isEV ? 'Ï∂©Ï†ÑÏÜå' : 'Ï£ºÏú†ÏÜå',
      stationPlaceholder: isEV
        ? 'Ï∂©Ï†ÑÏÜåÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî'
        : 'Ï£ºÏú†ÏÜåÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî',
      amountPlaceholder: isEV ? 'Ïòà: 45.2' : 'Ïòà: 30.5',
      unitPricePlaceholder: isEV ? 'Ïòà: 280' : 'Ïòà: 1,650',
    }),
    [isEV],
  );

  // ÏûêÎèô Í≥ÑÏÇ∞ Ìï®ÏàòÎì§
  const calculateAmount = () => {
    if (energyRecord.totalCost > 0 && energyRecord.unitPrice > 0) {
      const calculatedAmount = energyRecord.totalCost / energyRecord.unitPrice;
      dispatch({
        type: 'SET_FIELD',
        field: 'amount',
        value: Math.round(calculatedAmount * 100) / 100,
      });
    }
  };

  const calculateTotalCost = () => {
    if (energyRecord.amount > 0 && energyRecord.unitPrice > 0) {
      const calculatedTotalCost = energyRecord.amount * energyRecord.unitPrice;
      dispatch({
        type: 'SET_FIELD',
        field: 'totalCost',
        value: Math.round(calculatedTotalCost),
      });
    }
  };

  // ÏûÖÎ†•Í∞í Î≥ÄÍ≤Ω Ìï∏Îì§Îü¨Îì§
  const handleTotalCostChange = (value: string) => {
    const numericValue = parseFloat(value.replace(/,/g, '')) || 0;
    dispatch({ type: 'SET_FIELD', field: 'totalCost', value: numericValue });
  };

  const handleUnitPriceChange = (value: string) => {
    const numericValue = parseFloat(value.replace(/,/g, '')) || 0;
    dispatch({ type: 'SET_FIELD', field: 'unitPrice', value: numericValue });
  };

  const handleAmountChange = (value: string) => {
    const numericValue = parseFloat(value) || 0;
    dispatch({ type: 'SET_FIELD', field: 'amount', value: numericValue });
  };

  const handleMemoChange = (value: string) => {
    dispatch({ type: 'SET_FIELD', field: 'memo', value });
  };

  const handleTotalDistanceChange = (value: string) => {
    const numericValue = parseFloat(value) || 0;
    dispatch({ type: 'SET_FIELD', field: 'odometer', value: numericValue });
  };

  const handleDateChange = (day: { dateString: string }) => {
    if (day.dateString) {
      const dateString = formatDate(new Date(day.dateString), 'yyyy-MM-dd', {
        locale: ko,
      });
      dispatch({ type: 'SET_FIELD', field: 'date', value: dateString });
      dateModal.close();
    }
  };

  // Í∞í ÌëúÏãú Ìï®ÏàòÎì§ (0Ïùº Îïå Îπà Î¨∏ÏûêÏó¥)
  const displayValue = (value: number) => (value === 0 ? '' : value.toString());
  const displayCurrency = (value: number) =>
    value === 0 ? '' : value.toLocaleString();

  const markedDates: MarkedDates = useMemo(() => {
    const selectedColor = calendarTheme.selectedColor;
    const marked = {
      [format(new Date(energyRecord.date), 'yyyy-MM-dd')]: {
        selected: true,
        selectedColor,
      },
    };

    return marked;
  }, [energyRecord.date]);

  return (
    <>
      <Box className="flex-1 relative">
        <ScrollView
          className="flex-1 bg-gray-50"
          contentContainerStyle={{ paddingBottom: 56 }}
          showsVerticalScrollIndicator={false}
          keyboardShouldPersistTaps="handled"
        >
          <Box className="px-4 py-6">
            <FormControl className="flex-1">
              <FormCard>
                <FormLabel name="Ï£ºÌñâ Ï†ïÎ≥¥" />
                <FormField
                  type="number"
                  label="Ï¥ù Ï£ºÌñâÍ±∞Î¶¨ (km)"
                  value={displayValue(energyRecord.odometer)}
                  onChangeText={handleTotalDistanceChange}
                  placeholder="Ïòà: 100"
                  keyboardType="numeric"
                />
              </FormCard>

              {/* ÏóêÎÑàÏßÄ Ï†ïÎ≥¥ Ïπ¥Îìú - ÎèôÏ†Å */}
              <FormCard>
                <FormLabel
                  name={`${config.icon} ${config.energyType} Ï†ïÎ≥¥`}
                  size="lg"
                />

                <Box>
                  <FormLabel name="ÎÇ†Ïßú" size="sm" />
                  <Button
                    onPress={dateModal.open}
                    className="rounded-xl border-2 border-gray-200 bg-gray-50 active:border-primary-500 active:bg-white transition-all w-full justify-start"
                  >
                    <ButtonText className="font-medium text-gray-900">
                      {formatDateForDisplay(new Date(energyRecord.date)) ||
                        'ÎÇ†ÏßúÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî'}
                    </ButtonText>
                  </Button>

                  <DateSelectModal
                    isOpen={dateModal.isOpen}
                    onClose={dateModal.close}
                    currentDate={new Date(energyRecord.date)}
                    onDayPress={handleDateChange}
                    markedDates={markedDates}
                  />
                </Box>

                <FormField
                  type="number"
                  label="Ï¥ù ÎπÑÏö©"
                  value={displayCurrency(energyRecord.totalCost)}
                  onChangeText={handleTotalCostChange}
                  placeholder="Ïòà: 50,000"
                  keyboardType="numeric"
                  onBlur={calculateAmount}
                />

                <FormField
                  type="number"
                  label={`Îã®Í∞Ä (${config.unitPrice})`}
                  value={displayCurrency(energyRecord.unitPrice)}
                  onChangeText={handleUnitPriceChange}
                  placeholder={config.unitPricePlaceholder}
                  keyboardType="numeric"
                  onBlur={() => {
                    // Îã®Í∞Ä Î≥ÄÍ≤Ω Ïãú Ï¥ù ÎπÑÏö©Ïù¥ ÏûàÏúºÎ©¥ Ï£ºÏú†/Ï∂©Ï†ÑÎüâ Í≥ÑÏÇ∞, Ï£ºÏú†/Ï∂©Ï†ÑÎüâÏù¥ ÏûàÏúºÎ©¥ Ï¥ù ÎπÑÏö© Í≥ÑÏÇ∞
                    if (energyRecord.totalCost > 0) {
                      calculateAmount();
                    } else if (energyRecord.amount > 0) {
                      calculateTotalCost();
                    }
                  }}
                />

                <FormField
                  type="number"
                  label={`${config.energyType}Îüâ (${config.unit})`}
                  value={displayValue(energyRecord.amount)}
                  onChangeText={handleAmountChange}
                  placeholder={config.amountPlaceholder}
                  keyboardType="numeric"
                  onBlur={calculateTotalCost}
                />

                <Box>
                  <FormLabel name={config.station} size="sm" />
                  <Button
                    onPress={stationModal.open}
                    className="w-full rounded-xl border-2 border-gray-200 bg-gray-50 justify-start px-3"
                  >
                    <ButtonText className="text-lg font-medium text-gray-700">
                      {selectedStation?.name || config.stationPlaceholder}
                    </ButtonText>
                  </Button>
                  <StationPickerModal
                    isOpen={stationModal.isOpen}
                    onClose={stationModal.close}
                    onSelectStation={(station) => {
                      dispatch({
                        type: 'BULK_UPDATE',
                        payload: {
                          stationId: station.id,
                          stationName: station.name,
                        },
                      });
                      stationModal.close();
                    }}
                  />
                </Box>
              </FormCard>

              {/* Í≤∞Ï†ú Ï†ïÎ≥¥ Ïπ¥Îìú */}
              <FormCard>
                <FormLabel name="Í≤∞Ï†ú Ï†ïÎ≥¥" />

                <Box>
                  <FormLabel name="Í≤∞Ï†ú Î∞©Î≤ï" size="sm" />
                  <Button
                    variant="outline"
                    onPress={paymentModal.open}
                    className="w-full rounded-xl border-2 border-gray-200 bg-gray-50 justify-start text-gray-700"
                  >
                    <ButtonText>
                      {energyRecord.paymentName || 'Í≤∞Ï†ú ÏàòÎã® ÏÑ†ÌÉù'}
                    </ButtonText>
                  </Button>

                  <PaymentMethodModal
                    isOpen={paymentModal.isOpen}
                    onClose={paymentModal.close}
                    onSelectPaymentMethod={(paymentMethod) => {
                      dispatch({
                        type: 'BULK_UPDATE',
                        payload: {
                          paymentMethodId: paymentMethod.id,
                          paymentName: paymentMethod.name,
                          paymentType: paymentMethod.type,
                        },
                      });
                      paymentModal.close();
                    }}
                  />
                </Box>
              </FormCard>

              {/* Î©îÎ™® Ïπ¥Îìú - Í≥µÌÜµ */}
              <FormCard>
                <FormLabel name="Î©îÎ™®" />
                <FormField
                  type="textarea"
                  value={energyRecord.memo || ''}
                  onChangeText={handleMemoChange}
                  placeholder="ÌäπÏù¥ÏÇ¨Ìï≠Ïù¥ÎÇò Í∏∞ÏñµÌïòÍ≥† Ïã∂ÏùÄ ÎÇ¥Ïö©ÏùÑ Ï†ÅÏñ¥Î≥¥ÏÑ∏Ïöî (ÏÑ†ÌÉùÏÇ¨Ìï≠)"
                  numberOfLines={4}
                  multiline={true}
                />
              </FormCard>
            </FormControl>
          </Box>
        </ScrollView>
        {/* ÌïòÎã® Í≥†Ï†ï Ï†ÄÏû• Î≤ÑÌäº ÏòÅÏó≠ - ÎèôÏ†Å */}
        <FloatingSubmitButton
          onSubmit={() => onSubmit(energyRecord)}
          buttonIcon={isEV ? 'üîã' : '‚õΩ'}
          buttonText={isEV ? 'Ï∂©Ï†Ñ Í∏∞Î°ù Ï†ÄÏû•' : 'Ï£ºÏú† Í∏∞Î°ù Ï†ÄÏû•'}
        />
      </Box>
    </>
  );
}

// ÌÉÄÏûÖ export (Îã§Î•∏ ÌååÏùºÏóêÏÑú ÏÇ¨Ïö©Ìï† Ïàò ÏûàÎèÑÎ°ù)
export type { EnergyRecordFormData, EnergyRecordFormProps };
